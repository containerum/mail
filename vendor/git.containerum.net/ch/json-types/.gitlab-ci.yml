stages:
  - test

.correct_workdir: &correct_workdir
  before_script:
    - export CI_DOMAIN=$(echo ${CI_PROJECT_URL} | awk -F/ '{print $3}')
    - mkdir -p /go/src/${CI_DOMAIN}/${CI_PROJECT_PATH%/*}
    - ln -sf ${CI_PROJECT_DIR} /go/src/${CI_DOMAIN}/${CI_PROJECT_PATH}
    - cd /go/src/${CI_DOMAIN}/${CI_PROJECT_PATH}

lint-check:
  <<: *correct_workdir
  image: golang:1.9-alpine
  stage: test
  tags:
    - test
  script:
    - apk add --no-cache openssl git
    - git config --global url."https://gitlab-ci-token:${CI_JOB_TOKEN}@${CI_DOMAIN}".insteadOf "https://${CI_DOMAIN}"
    - wget -O - https://github.com/alecthomas/gometalinter/releases/download/v2.0.3/gometalinter-v2.0.3-linux-amd64.tar.bz2 | tar -C /go -xjf -
    - export PATH=$PATH:/go/gometalinter-v2.0.3-linux-amd64:/go/gometalinter-v2.0.3-linux-amd64/linters
    - go-wrapper download ./...
    - gometalinter ./...